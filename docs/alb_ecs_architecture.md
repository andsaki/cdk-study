# ALB + ECS Fargate アーキテクチャ

このドキュメントでは、Application Load Balancer (ALB) と ECS Fargate を使用したコンテナベースのアーキテクチャについて説明します。

## 概要

このアーキテクチャは、コンテナ化されたアプリケーションをサーバーレスに実行するためのパターンです。
EC2インスタンスの管理が不要で、コンテナの実行に必要なリソースを指定するだけで動作します。

## アーキテクチャ図

```
インターネット
    |
    v
[Application Load Balancer] (Public Subnet)
    |
    v
[ECS Fargate Tasks] (Private Subnet)
    | (1〜10台, Auto Scaling)
    v
[DynamoDB / 外部API]
```

## 主要コンポーネント

### 1. VPC (Virtual Private Cloud)

**役割:**
- プライベートなネットワーク空間を作成
- リソース間の通信を制御
- インターネットとの接続を管理

**設定:**
- アベイラビリティゾーン: 2つ（高可用性）
- NAT Gateway: 1つ（コスト削減、本番では2推奨）
- サブネット:
  - Public Subnet: ALB配置用（インターネットから直接アクセス可能）
  - Private Subnet: ECS配置用（インターネットから直接アクセス不可）

### 2. Application Load Balancer (ALB)

**役割:**
- 複数のコンテナにトラフィックを分散
- ヘルスチェックで異常なコンテナを自動的に除外
- パスベースルーティング（/api → API、/static → 静的コンテンツ等）
- SSL/TLS終端（HTTPS通信の暗号化/復号化）

**設定:**
- 配置: Public Subnet
- リスナー: HTTP (80)
- セキュリティグループ: インターネットからHTTP/HTTPS許可

### 3. ECS Fargate

**Fargateとは:**
- サーバーレスなコンテナ実行環境
- EC2インスタンスの管理が不要
- 必要なCPU/メモリを指定するだけで実行可能

**Task Definition（コンテナ設定）:**
- CPU: 0.25 vCPU (256)
- メモリ: 512 MB
- アーキテクチャ: ARM64（Graviton2、x86より約20%安い）
- ポート: 3000 (Node.jsアプリ)

**Service（実行管理）:**
- 配置: Private Subnet
- 初期タスク数: 1
- デプロイ戦略: ローリングアップデート
- ヘルスチェック猶予期間: 60秒

### 4. Auto Scaling

**役割:**
- 負荷に応じてタスク数を自動調整
- コスト最適化とパフォーマンス維持を両立

**設定:**
- 最小タスク数: 1
- 最大タスク数: 10
- スケーリングポリシー:
  - CPU使用率 70%超えでスケールアウト
  - メモリ使用率 80%超えでスケールアウト
- クールダウン期間: 60秒（頻繁なスケーリングを防止）

### 5. セキュリティグループ

**ALB用:**
- インバウンド: HTTP (80), HTTPS (443) をインターネット全体から許可
- アウトバウンド: 全て許可（ECSへの通信）

**ECS用:**
- インバウンド: ポート3000をALBからのみ許可
- アウトバウンド: 全て許可（DynamoDB等へのアクセス）

## 料金

### 東京リージョンでの月額料金（概算）

**コンテナ (Fargate):**
- 1台あたり: 約$9/月
- 通常時（1台）: 約$9/月
- 最大時（10台）: 約$86/月

**その他のコスト:**
- ALB: 約$20/月（固定）+ データ転送料
- NAT Gateway: 約$35/月（固定）+ データ転送料

**合計:**
- 通常時: 約$65〜75/月
- 最大時: 約$140〜150/月

### コスト削減のポイント

1. **Auto Scalingの活用**
   - 通常時は最小台数で運用
   - 負荷が高い時だけ自動増加

2. **ARM64の使用**
   - x86より約20%安い

3. **適切なリソース設定**
   - 必要最小限のCPU/メモリを設定

## API Gateway + Lambda との比較

### ALB + ECS Fargateが適している場合

- **長時間実行が必要**: Lambda（最大15分）の制限を超える処理
- **WebSocket対応**: リアルタイム双方向通信が必要
- **既存のDockerコンテナ**: 既にコンテナ化されたアプリがある
- **複雑なルーティング**: パスベースやホストベースの柔軟なルーティング
- **安定した負荷**: 常時一定のトラフィックがある

### API Gateway + Lambdaが適している場合

- **完全サーバーレス**: インフラ管理を最小化したい
- **間欠的なトラフィック**: アクセスがない時は課金されない
- **短時間処理**: 15分以内で完了する処理
- **低コスト**: 小規模〜中規模のトラフィック

詳細な比較は [`architecture_comparison_alb_vs_apigateway.md`](architecture_comparison_alb_vs_apigateway.md) を参照してください。

## デプロイ方法

### 前提条件

- AWS CDKのインストール
- Dockerのインストール（ローカルでイメージをビルドするため）

### デプロイコマンド

```bash
# ALBスタックをデプロイ
npx cdk deploy AlbStack
```

### デプロイ後の確認

デプロイが完了すると、以下の情報が出力されます：

```
Outputs:
AlbStack.LoadBalancerDNS = http://xxx.ap-northeast-1.elb.amazonaws.com
AlbStack.VpcId = vpc-xxxxx
AlbStack.ClusterName = todo-alb-cluster
```

`LoadBalancerDNS` のURLにアクセスすると、アプリケーションが表示されます。

## 監視とトラブルシューティング

### CloudWatch Logs

コンテナのログは自動的にCloudWatch Logsに送信されます：

- ロググループ: `/ecs/todo-alb`
- 保持期間: 1週間

### Container Insights

有効化されているため、以下のメトリクスをCloudWatchで確認できます：

- CPU使用率
- メモリ使用率
- ネットワークトラフィック
- タスク数

### ヘルスチェック

ALBは30秒ごとに `/health` エンドポイントにリクエストを送信します：

- 成功基準: 2回連続成功
- 失敗基準: 3回連続失敗
- タイムアウト: 5秒

## セキュリティのベストプラクティス

1. **Private Subnetの使用**
   - ECSタスクはPrivate Subnetに配置
   - インターネットから直接アクセス不可

2. **セキュリティグループの最小権限**
   - 必要なトラフィックのみ許可

3. **HTTPS化**（本番環境推奨）
   - ACMで証明書を発行
   - ALBのリスナーにHTTPSを追加
   - HTTP → HTTPSリダイレクト

4. **IAMロール**
   - タスクに必要最小限の権限を付与
   - DynamoDBへのアクセス等

## まとめ

このアーキテクチャは、以下のような特徴があります：

**メリット:**
- サーバー管理不要（Fargate）
- 高可用性（複数AZ、Auto Scaling）
- 柔軟なルーティング（ALB）
- 長時間実行可能

**デメリット:**
- Lambda + API Gatewayより若干コスト高
- コールドスタートは無いが、最小台数は常に課金

学習目的で、コンテナベースのアーキテクチャを理解するのに最適です。
