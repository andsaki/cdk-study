# セキュリティアーキテクチャ図

このドキュメントでは、TODO Appのセキュリティアーキテクチャを視覚的に説明します。

## 全体アーキテクチャ - セキュリティレイヤー付き

```
┌──────────────────────────────────────────────────────────────────────┐
│                           エンドユーザー                              │
│                         (ブラウザ/アプリ)                             │
└────────────────────────────┬─────────────────────────────────────────┘
                             │
                             │ HTTPS (TLS 1.2+)
                             ↓
┌──────────────────────────────────────────────────────────────────────┐
│                    【フロントエンド配信層】                           │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │                    Amazon CloudFront                        │     │
│  │  • HTTPS強制（HTTP→HTTPSリダイレクト）                      │     │
│  │  • TLS 1.2以上のみ許可                                      │     │
│  │  • セキュリティヘッダー自動付与:                            │     │
│  │    - X-Content-Type-Options: nosniff                       │     │
│  │    - X-Frame-Options: DENY                                 │     │
│  │    - Strict-Transport-Security (HSTS)                      │     │
│  │    - X-XSS-Protection                                      │     │
│  │  • AWS Shield Standard (DDoS保護)                          │     │
│  │  • Origin Access Identity (OAI) でS3へのアクセス制御        │     │
│  └────────────────────────────────────────────────────────────┘     │
└────────────────────────────┬─────────────────────────────────────────┘
                             │ OAI経由でのみアクセス可能
                             ↓
┌──────────────────────────────────────────────────────────────────────┐
│                    【静的コンテンツ保存層】                           │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │                      Amazon S3                              │     │
│  │  • SSE-S3 保存時暗号化 (AES-256)                            │     │
│  │  • enforceSSL: true (HTTPS必須)                             │     │
│  │  • パブリックアクセス完全ブロック                            │     │
│  │  • バケットポリシーでOAIのみ許可                             │     │
│  └────────────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────────────┘


                        【バックエンドAPI】

┌──────────────────────────────────────────────────────────────────────┐
│                           エンドユーザー                              │
│                    (x-api-key ヘッダー付き)                           │
└────────────────────────────┬─────────────────────────────────────────┘
                             │ HTTPS
                             ↓
┌──────────────────────────────────────────────────────────────────────┐
│                 【レイヤー1: WAF - 攻撃検出・防御】                   │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │                       AWS WAF                               │     │
│  │  ┌──────────────────────────────────────────────────────┐  │     │
│  │  │ ルール1: AWSManagedRulesCommonRuleSet              │  │     │
│  │  │  • SQLインジェクション検査                          │  │     │
│  │  │  • XSS (クロスサイトスクリプティング) 検査         │  │     │
│  │  │  • パストラバーサル検査                            │  │     │
│  │  │  • LFI/RFI 検査                                    │  │     │
│  │  └──────────────────────────────────────────────────────┘  │     │
│  │  ┌──────────────────────────────────────────────────────┐  │     │
│  │  │ ルール2: AWSManagedRulesKnownBadInputsRuleSet      │  │     │
│  │  │  • Log4Shell 検査                                  │  │     │
│  │  │  • ShellShock 検査                                 │  │     │
│  │  │  • その他既知の脆弱性パターン検査                   │  │     │
│  │  └──────────────────────────────────────────────────────┘  │     │
│  │  ┌──────────────────────────────────────────────────────┐  │     │
│  │  │ ルール3: RateLimitRule (DDoS緩和)                  │  │     │
│  │  │  • IPアドレスごとに集計                            │  │     │
│  │  │  • 5分間で2000リクエスト超過時ブロック             │  │     │
│  │  └──────────────────────────────────────────────────────┘  │     │
│  └────────────────────────────────────────────────────────────┘     │
└────────────────────────────┬─────────────────────────────────────────┘
                             │ WAF検証通過
                             ↓
┌──────────────────────────────────────────────────────────────────────┐
│              【レイヤー2: API Gateway - 認証・認可】                  │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │                  Amazon API Gateway                         │     │
│  │  ┌──────────────────────────────────────────────────────┐  │     │
│  │  │ APIキー認証                                         │  │     │
│  │  │  • x-api-key ヘッダーの検証                        │  │     │
│  │  │  • 無効なキー → 403 Forbidden                      │  │     │
│  │  └──────────────────────────────────────────────────────┘  │     │
│  │  ┌──────────────────────────────────────────────────────┐  │     │
│  │  │ Usage Plan (スロットリング)                        │  │     │
│  │  │  • レート制限: 100 req/秒                          │  │     │
│  │  │  • バースト制限: 200 req                           │  │     │
│  │  │  • クォータ: 10,000 req/日                         │  │     │
│  │  │  • 超過時 → 429 Too Many Requests                  │  │     │
│  │  └──────────────────────────────────────────────────────┘  │     │
│  │  ┌──────────────────────────────────────────────────────┐  │     │
│  │  │ CORS検証                                           │  │     │
│  │  │  • CloudFrontドメインのみ許可                      │  │     │
│  │  │  • 他オリジン → ブラウザがブロック                 │  │     │
│  │  └──────────────────────────────────────────────────────┘  │     │
│  │  ┌──────────────────────────────────────────────────────┐  │     │
│  │  │ その他のセキュリティ機能                            │  │     │
│  │  │  • X-Rayトレーシング有効化                         │  │     │
│  │  │  • CloudWatch詳細ログ記録                          │  │     │
│  │  │  • リクエスト/レスポンスのログ記録                  │  │     │
│  │  └──────────────────────────────────────────────────────┘  │     │
│  └────────────────────────────────────────────────────────────┘     │
└────────────────────────────┬─────────────────────────────────────────┘
                             │ 認証済みリクエスト
                             ↓
┌──────────────────────────────────────────────────────────────────────┐
│            【レイヤー3: Lambda - ビジネスロジック実行】               │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │                      AWS Lambda                             │     │
│  │  ┌──────────────────────────────────────────────────────┐  │     │
│  │  │ IAM ロール (最小権限の原則)                        │  │     │
│  │  │  • 各関数に必要な権限のみ付与                      │  │     │
│  │  │  • 例: GetTodosFunction → DynamoDB読み取りのみ     │  │     │
│  │  │  • 例: CreateTodoFunction → DynamoDB書き込みのみ   │  │     │
│  │  └──────────────────────────────────────────────────────┘  │     │
│  │  ┌──────────────────────────────────────────────────────┐  │     │
│  │  │ X-Ray アクティブトレーシング                       │  │     │
│  │  │  • リクエストフローの可視化                        │  │     │
│  │  │  • パフォーマンスボトルネックの特定                │  │     │
│  │  └──────────────────────────────────────────────────────┘  │     │
│  │  ┌──────────────────────────────────────────────────────┐  │     │
│  │  │ CloudWatch Logs                                    │  │     │
│  │  │  • ログ保持期間: 1週間                             │  │     │
│  │  │  • エラーログの記録                                │  │     │
│  │  └──────────────────────────────────────────────────────┘  │     │
│  └────────────────────────────────────────────────────────────┘     │
└────────────────────────────┬─────────────────────────────────────────┘
                             │ DynamoDB操作 (IAM権限チェック)
                             ↓
┌──────────────────────────────────────────────────────────────────────┐
│                  【レイヤー4: データ永続化層】                        │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │                    Amazon DynamoDB                          │     │
│  │  ┌──────────────────────────────────────────────────────┐  │     │
│  │  │ 保存時暗号化 (Encryption at Rest)                  │  │     │
│  │  │  • SSE-DynamoDB (AWS管理キー)                      │  │     │
│  │  │  • 暗号化方式: AES-256                             │  │     │
│  │  │  • 書き込み時: 自動暗号化                          │  │     │
│  │  │  • 読み取り時: 自動復号化                          │  │     │
│  │  └──────────────────────────────────────────────────────┘  │     │
│  │  ┌──────────────────────────────────────────────────────┐  │     │
│  │  │ ポイントインタイムリカバリ (PITR)                  │  │     │
│  │  │  • 過去35日間の任意の時点に復元可能                │  │     │
│  │  │  • 誤削除・データ破損からの復旧                    │  │     │
│  │  └──────────────────────────────────────────────────────┘  │     │
│  │  ┌──────────────────────────────────────────────────────┐  │     │
│  │  │ IAMベースのアクセス制御                            │  │     │
│  │  │  • Lambda関数のIAMロールで制御                     │  │     │
│  │  │  • 各関数に個別の権限を付与                        │  │     │
│  │  └──────────────────────────────────────────────────────┘  │     │
│  └────────────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────────────┘


                   【機密情報管理 - Secrets Manager】

┌──────────────────────────────────────────────────────────────────────┐
│                   AWS Secrets Manager                                 │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │ 保存される情報:                                            │     │
│  │  • APIキー設定情報                                         │     │
│  │  • 将来的な機密情報 (DB認証情報、外部API鍵など)            │     │
│  └────────────────────────────────────────────────────────────┘     │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │ セキュリティ機能:                                          │     │
│  │  • KMSキーによる自動暗号化                                 │     │
│  │  • アクセス履歴をCloudTrailで監査                          │     │
│  │  • IAMポリシーによるアクセス制御                           │     │
│  │  • シークレットのローテーション機能                        │     │
│  └────────────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────────────┘


                      【監視・監査レイヤー】

┌──────────────────────────────────────────────────────────────────────┐
│                      Amazon CloudWatch                                │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │ メトリクス監視:                                            │     │
│  │  • Lambda: エラー数、スロットル数、実行時間                │     │
│  │  • API Gateway: 4XX/5XXエラー、レイテンシ                 │     │
│  │  • DynamoDB: 読み取り/書き込みスループット                 │     │
│  └────────────────────────────────────────────────────────────┘     │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │ アラーム設定:                                              │     │
│  │  • Lambda Errorアラーム: 5分間で5回以上のエラー            │     │
│  │  • Lambda Throttleアラーム: 5分間で3回以上のスロットル     │     │
│  │  • 発火時: SNS通知 (要設定)                                │     │
│  └────────────────────────────────────────────────────────────┘     │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │ ログ記録:                                                  │     │
│  │  • Lambda実行ログ (保持期間: 1週間)                        │     │
│  │  • API Gatewayアクセスログ                                 │     │
│  │  • WAFログ (オプション)                                    │     │
│  └────────────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────┐
│                         AWS X-Ray                                     │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │ 分散トレーシング:                                          │     │
│  │  • API Gateway → Lambda → DynamoDB の呼び出しフロー可視化  │     │
│  │  • レイテンシの内訳分析                                    │     │
│  │  • ボトルネックの特定                                      │     │
│  │  • エラーの根本原因分析                                    │     │
│  └────────────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────┐
│                      AWS CloudTrail (AWS標準)                         │
│  ┌────────────────────────────────────────────────────────────┐     │
│  │ API呼び出しの監査ログ:                                     │     │
│  │  • AWSリソースへの全API呼び出しを記録                      │     │
│  │  • 誰が、いつ、何をしたかを追跡                            │     │
│  │  • コンプライアンス要件への対応                            │     │
│  └────────────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────────────┘
```

## セキュリティの多層防御まとめ

このアーキテクチャは、**7つのセキュリティレイヤー**で構成されています：

### 1層目: ネットワーク保護層 (CloudFront)
- HTTPS強制、TLS 1.2+
- セキュリティヘッダー
- DDoS保護 (AWS Shield)

### 2層目: アプリケーションファイアウォール層 (WAF)
- SQLインジェクション/XSS対策
- 既知の脆弱性パターン検出
- レート制限によるDDoS緩和

### 3層目: 認証・認可層 (API Gateway)
- APIキー認証
- スロットリング
- CORS制限

### 4層目: 実行環境層 (Lambda)
- IAM最小権限
- X-Rayトレーシング
- ログ記録

### 5層目: データ保護層 (DynamoDB/S3)
- 保存時暗号化
- ポイントインタイムリカバリ
- パブリックアクセス禁止

### 6層目: 機密情報管理層 (Secrets Manager)
- KMS暗号化
- アクセス監査
- ローテーション機能

### 7層目: 監視・監査層 (CloudWatch/X-Ray/CloudTrail)
- メトリクス監視
- アラーム通知
- トレーシング
- 監査ログ

---

## データフロー - セキュリティチェックポイント付き

```
[ユーザー]
    |
    | ① HTTPS/TLS 1.2+ 暗号化通信
    ↓
[CloudFront]
    | セキュリティヘッダー追加
    | HTTPS強制
    | AWS Shield (DDoS保護)
    |
    | ② WAFルール適用
    ↓
[AWS WAF]
    | SQLインジェクション検査 ✓
    | XSS検査 ✓
    | レート制限チェック ✓
    | → NG なら 403 Forbidden
    |
    | ③ APIキー検証
    ↓
[API Gateway]
    | x-api-keyヘッダー検証 ✓
    | スロットリング適用 ✓
    | CORS検証 ✓
    | → NG なら 403/429
    |
    | ④ IAM権限チェック
    ↓
[Lambda]
    | IAMロールで権限確認 ✓
    | X-Rayトレース記録
    | CloudWatch Logs記録
    |
    | ⑤ データアクセス (IAM制御)
    ↓
[DynamoDB]
    | IAM権限で読み書き制御 ✓
    | 自動暗号化 (書き込み時)
    | 自動復号化 (読み取り時)
    | PITR自動バックアップ
    |
    | ⑥ レスポンス返却
    ↓
[Lambda] → [API Gateway] → [CloudFront] → [ユーザー]
    全てHTTPS/TLS暗号化通信
```

各チェックポイント (①〜⑥) のいずれかで不正が検出された場合、
後続の処理には進まず、適切なエラーレスポンスが返却されます。

---

## 参考: AWS Well-Architected Framework - セキュリティの柱への対応

| Well-Architected 項目 | 実装内容 |
|---------------------|---------|
| **Identity and Access Management** | IAM最小権限、APIキー認証 |
| **Detection** | CloudWatch Alarms、X-Ray、CloudTrail |
| **Infrastructure Protection** | WAF、VPC (将来的)、セキュリティグループ |
| **Data Protection** | 保存時暗号化 (DynamoDB/S3)、転送時暗号化 (TLS) |
| **Incident Response** | CloudWatch Logs、X-Rayトレース |
