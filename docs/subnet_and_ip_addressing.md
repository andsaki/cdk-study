# Subnet と IPアドレスの関係

SubnetはIPアドレスの範囲を分割したものです。このドキュメントでは、VPCとSubnetの基本的な仕組みをわかりやすく解説します。

## 基本的な仕組み

### 全体像

```
VPC (家全体)
├─ Public Subnet (玄関・リビング) ... 10.0.0.0/24
└─ Private Subnet (奥の部屋) ......... 10.0.128.0/24
```

## VPCのIPアドレス範囲

VPC全体でIPアドレスの範囲を決めます：

```typescript
const vpc = new ec2.Vpc(this, 'AlbVpc', {
  maxAzs: 2,
  // デフォルトで 10.0.0.0/16 が割り当てられる
});
```

### 10.0.0.0/16 の意味

| 項目 | 値 |
|------|-----|
| IPアドレス範囲 | 10.0.0.0 〜 10.0.255.255 |
| 使えるIP数 | 約65,536個 |
| 先頭固定ビット | 16ビット（10.0.x.x の部分） |
| 変動可能ビット | 16ビット（x.x の部分） |

## Subnetで分割

65,536個のIPアドレスを小分けにします：

```typescript
subnetConfiguration: [
  {
    cidrMask: 24,  // ← IPアドレス範囲の指定
    name: 'Public',
    subnetType: ec2.SubnetType.PUBLIC,
  },
  {
    cidrMask: 24,
    name: 'Private',
    subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS,
  },
],
```

## このプロジェクトの実際の分割

2つのAZ × 2種類のサブネット = **4つのサブネット**

| サブネット名 | IPアドレス範囲 | 使えるIP数 | 配置するもの |
|-------------|----------------|-----------|-------------|
| **Public Subnet AZ1** | 10.0.0.0/24 | 251個 | ALB, NAT Gateway |
| **Public Subnet AZ2** | 10.0.1.0/24 | 251個 | ALB |
| **Private Subnet AZ1** | 10.0.128.0/24 | 251個 | ECS Fargate |
| **Private Subnet AZ2** | 10.0.129.0/24 | 251個 | ECS Fargate |

### なぜ251個？

256個中、AWSが5個予約しているため：

```
10.0.0.0   ← ネットワークアドレス（使えない）
10.0.0.1   ← VPCルーター用（AWSが予約）
10.0.0.2   ← DNS用（AWSが予約）
10.0.0.3   ← 将来の用途（AWSが予約）
10.0.0.4   ← 実際に使える最初のIP ★
10.0.0.5
10.0.0.6
...
10.0.0.254 ← 実際に使える最後のIP ★
10.0.0.255 ← ブロードキャストアドレス（使えない）
```

**実際に使えるIP:** 256 - 5 = **251個**

## CIDR表記の読み方

### /24 の意味

**表記:** 10.0.0.0/24

```
10    .0     .0     .0      /24
└─固定─┴─固定─┴─固定─┴─変動─┘

/24 = 先頭24ビットが固定
    = 10.0.0.x の部分だけ変動
    = 2^8 = 256個のIPアドレス
```

### よく使うCIDR早見表

| CIDR | 使えるIP数（概算） | 用途例 |
|------|-------------------|--------|
| /32 | 1個 | 特定のIP1つだけ |
| /28 | 16個 | 超小規模サブネット |
| /24 | 256個 | 小規模サブネット（このプロジェクト） |
| /20 | 4,096個 | 中規模サブネット |
| /16 | 65,536個 | VPC全体 |
| /8 | 16,777,216個 | 超大規模（クラスA） |

## 実際のIPアドレス割り当て

### ECSタスクの例

ECSタスクが起動すると、Private SubnetのIPアドレスが自動で割り当てられます：

```
Private Subnet AZ1 (10.0.128.0/24)

10.0.128.1  ← VPCルーター
10.0.128.2  ← DNS
10.0.128.3  ← AWS予約
10.0.128.4  ← ECS Task 1 ★
10.0.128.5  ← ECS Task 2 ★
10.0.128.6  ← ECS Task 3 ★
...
```

### ALBの例

```
Public Subnet AZ1 (10.0.0.0/24)

10.0.0.1  ← VPCルーター
10.0.0.2  ← DNS
10.0.0.3  ← AWS予約
10.0.0.4  ← ALB（自動割り当て） ★
10.0.0.5  ← NAT Gateway ★
...
```

## なぜSubnetを分けるのか

### 1. セキュリティ

```
┌───────────────────────────────┐
│ Public Subnet (10.0.0.0/24)   │  ← インターネットから見える
│ - ALB                         │
└───────────┬───────────────────┘
            │ セキュリティグループで制御
            ↓
┌───────────────────────────────┐
│ Private Subnet (10.0.128.0/24)│  ← インターネットから見えない
│ - ECS Fargate                 │
└───────────────────────────────┘
```

**メリット:**
- IPアドレス範囲で通信を制御
- Private SubnetはPublic Subnetからのみアクセス可能
- 万が一ALBが侵害されても、Private Subnetは保護される

### 2. ルーティングの管理

各サブネットごとに異なるルートテーブルを設定：

**Public Subnet (10.0.0.0/24) のルート:**

| 宛先 | ターゲット | 説明 |
|------|-----------|------|
| 10.0.0.0/16 | local | VPC内部への通信 |
| 0.0.0.0/0 | Internet Gateway | インターネットへの通信（双方向） |

**Private Subnet (10.0.128.0/24) のルート:**

| 宛先 | ターゲット | 説明 |
|------|-----------|------|
| 10.0.0.0/16 | local | VPC内部への通信 |
| 0.0.0.0/0 | NAT Gateway | インターネットへの通信（送信のみ） |

### 3. リソースの整理

IPアドレスを見れば、リソースの場所が分かる：

```
10.0.0.x     → Public Subnet AZ1（ALB等）
10.0.1.x     → Public Subnet AZ2（ALB予備）
10.0.128.x   → Private Subnet AZ1（ECS）
10.0.129.x   → Private Subnet AZ2（ECS予備）
```

## セキュリティグループとの関係

セキュリティグループでIPアドレス範囲を指定して通信を制御：

```typescript
// ECS用セキュリティグループ
const ecsSecurityGroup = new ec2.SecurityGroup(this, 'EcsSecurityGroup', {
  vpc,
  description: 'Security group for ECS tasks',
});

// ALBからのみポート3000への通信を許可
ecsSecurityGroup.addIngressRule(
  albSecurityGroup,  // ALBのIP（10.0.0.x）からのみ
  ec2.Port.tcp(3000),
  'Allow traffic from ALB'
);
```

**実際の通信:**
```
ALB (10.0.0.4)
    ↓ ポート3000
ECS Task (10.0.128.4) ← 許可

インターネット (外部IP)
    ↓ ポート3000
ECS Task (10.0.128.4) ← 拒否（セキュリティグループでブロック）
```

## 図解: ネットワーク全体像

```
┌─────────────────────────────────────────────────────────┐
│                     インターネット                        │
└────────────────────┬────────────────────────────────────┘
                     │
          ┌──────────▼──────────┐
          │  Internet Gateway   │
          └──────────┬──────────┘
                     │
     ┌───────────────┴───────────────┐
     │                               │
     │  Public Subnet AZ1            │  Public Subnet AZ2
     │  10.0.0.0/24                  │  10.0.1.0/24
     │  ┌──────────┐ ┌────────────┐ │  ┌──────────┐
     │  │   ALB    │ │ NAT Gateway│ │  │   ALB    │
     │  │10.0.0.4  │ │ 10.0.0.5   │ │  │10.0.1.4  │
     │  └──────────┘ └──────┬─────┘ │  └──────────┘
     └───────┬───────────────┴───────┴───────┬──────┘
             │                               │
             │  セキュリティグループで制御    │
             │                               │
     ┌───────▼───────────────────────────────▼──────┐
     │                                               │
     │  Private Subnet AZ1       Private Subnet AZ2  │
     │  10.0.128.0/24           10.0.129.0/24        │
     │  ┌─────────────┐         ┌─────────────┐      │
     │  │ ECS Task 1  │         │ ECS Task 3  │      │
     │  │ 10.0.128.4  │         │ 10.0.129.4  │      │
     │  └─────────────┘         └─────────────┘      │
     │  ┌─────────────┐         ┌─────────────┐      │
     │  │ ECS Task 2  │         │ ECS Task 4  │      │
     │  │ 10.0.128.5  │         │ 10.0.129.5  │      │
     │  └─────────────┘         └─────────────┘      │
     └───────────────────────────────────────────────┘
                     │
                     │ NAT Gateway経由でインターネットアクセス（送信のみ）
                     ↓
            ┌────────────────┐
            │  外部API/ECR   │
            └────────────────┘
```

## よくある質問

### Q1. なぜPublic Subnetは 10.0.0.x で Private Subnetは 10.0.128.x なの？

**A.** CDKが自動で割り振っています。

- Public用: 前半のアドレス範囲（10.0.0.x〜）
- Private用: 後半のアドレス範囲（10.0.128.x〜）

明示的に指定することもできます：

```typescript
const vpc = new ec2.Vpc(this, 'CustomVpc', {
  ipAddresses: ec2.IpAddresses.cidr('10.0.0.0/16'),
  subnetConfiguration: [
    {
      cidrMask: 24,
      name: 'Public',
      subnetType: ec2.SubnetType.PUBLIC,
    },
  ],
});
```

### Q2. /24だと251個しか使えないけど、足りなくなったら？

**A.** cidrMaskを小さくします。

```typescript
{
  cidrMask: 20,  // /24 → /20 に変更
  // 256個 → 4,096個に増加
}
```

### Q3. 10.0.0.0 はなぜ使えないの？

**A.** ネットワークアドレスとして予約されているためです。

- **ネットワークアドレス**: そのサブネット全体を表すアドレス
- **ブロードキャストアドレス**: 全てのホストに送信するアドレス

これらは特別な用途で予約済みです。

### Q4. 他のプロジェクトでは 192.168.x.x を見たことがあるけど？

**A.** プライベートIPアドレスには3つの範囲があります。

| クラス | アドレス範囲 | 用途例 |
|-------|-------------|--------|
| クラスA | 10.0.0.0 〜 10.255.255.255 | AWS VPC、大規模ネットワーク |
| クラスB | 172.16.0.0 〜 172.31.255.255 | 中規模ネットワーク |
| クラスC | 192.168.0.0 〜 192.168.255.255 | 家庭内LAN、小規模オフィス |

AWSでは通常 `10.0.0.0/16` が使われます。

### Q5. Public SubnetにECSを置いたらダメなの？

**A.** 技術的には可能ですが、セキュリティ上推奨されません。

**Public Subnetに配置した場合:**
- インターネットから直接アクセス可能
- パブリックIPが割り当てられる
- 攻撃の対象になりやすい

**Private Subnetに配置した場合:**
- ALB経由でのみアクセス可能
- パブリックIPなし
- セキュリティが高い

## まとめ

| 項目 | 説明 |
|------|------|
| **VPC** | IPアドレスの大枠（10.0.0.0/16 = 65,536個） |
| **Subnet** | VPCを小分けしたもの（10.0.0.0/24 = 256個） |
| **Public Subnet** | インターネットから直接アクセス可能（ALB配置） |
| **Private Subnet** | インターネットから直接アクセス不可（ECS配置） |
| **CIDR** | IPアドレス範囲の表記方法（/24 = 256個） |
| **セキュリティグループ** | IPアドレス範囲で通信を制御 |

**覚えておくポイント:**
1. SubnetはIPアドレスの範囲
2. /24は256個（実際は251個）
3. Public = 玄関、Private = 奥の部屋
4. IPアドレスで場所が分かる
